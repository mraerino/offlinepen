<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/polymer/lib/utils/debounce.html">
<link rel="import" href="../bower_components/polymer/lib/utils/async.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/ace-widget/ace-widget.html">
<link rel="import" href="lib/dexie.html">
<link rel="import" href="lib/cuid.html">

<dom-module id="view-editor">
  <template>
    <style>
      :host {
        display: block;
      }

      header {
        display: flex;
        flex-direction: row;
      }

      header .backNav {
        text-decoration: none;
        background: darkgreen;
        color: white;
        font.size: 20px;
        padding: 10px;
        margin-right: 10px;
      }

      header .saveState {
        margin: 0 0 0 auto;
        padding: 10px;
      }

      main {
        display: flex;
        flex-direction: row;
        flex-wrap: wrap;
      }

      main section {
        flex: 1;
      }

      main section.preview-container {
        min-width: 100%;
      }
    </style>

    <app-route route="[[ route ]]" pattern="/:penId" data="{{ routeData }}" active="{{ editorActive }}"></app-route>

    <header>
      <a class="backNav" href="/list" title="Back to pen list">&lt;</a>
      <paper-input placeholder="Name of the pen" no-label-float value="{{ penMeta.name }}"></paper-input>
      <p class="saveState">[[ saveState ]]</p>
    </header>

    <main>
      <section>
        <h3>HTML</h3>
        <ace-widget mode="ace/mode/html" data-type="html" on-editor-content="editorChanged"></ace-widget>
      </section>

      <section>
        <h3>CSS</h3>
        <ace-widget mode="ace/mode/css" data-type="css" on-editor-content="editorChanged"></ace-widget>
      </section>

      <section>
        <h3>JS</h3>
        <ace-widget mode="ace/mode/javascript" data-type="js" on-editor-content="editorChanged"></ace-widget>
      </section>

      <section class="preview-container">
        Preview goes here :)
      </section>
    </main>
  </template>
</dom-module>

<script>
  class ViewEditor extends Polymer.Element {
    static get is() { return 'view-editor'; }

    static get properties() {
      return {
        route: {
          type: Object
        },
        currentId: {
          type: String,
          value: () => "",
          observer: 'fetchPen'
        },
        penMeta: {
          type: Object
        },
        hasSaved: {
          type: Boolean,
          value: true
        },
        saveState: {
          type: String,
          computed: 'computeSaveState(hasSaved)'
        },
        fetching: {
          type: Boolean,
          value: false
        }
      };
    }

    static get observers() {
      return [
        'routeChanged(routeData.*, editorActive)',
        'metaChanged(penMeta.*)'
      ];
    }

    constructor() {
      super();
      this._files = {};
    }

    routeChanged(change, active) {
      if(!active) {
        this.currentId = "";
        this.dispatchEvent(new CustomEvent('op-navigateTo', {
          detail: { path: '/list' },
          bubbles: true,
          composed: true
        }));
        return;
      }

      if(change.base && change.base.penId) {
        this.currentId = change.base.penId;
      }
    }

    fetchPen(id) {
      this.fetching = true;
      OfflinePen.db.pens.get(id)
        .then(pen => this.penMeta = pen)
        .then(() => OfflinePen.db.files.where('pen_id').equals(id).each(file => {
          const [name, type] = file.name.split('.');
          if(name !== 'index') {
            return;
          }
          this._files[type] = file;
          this.shadowRoot.querySelector(`ace-widget[data-type=${type}]`).value = file.content;
        }))
        .then(() => Polymer.Async.timeOut.run(() => this.fetching = false));
    }

    metaChanged(change) {
      if(this.currentId === "" || this.fetching || change.path === 'penMeta.id') {
        return;
      }

      this.hasSaved = false;
      this._metaDebouncer = Polymer.Debouncer.debounce(
        this._metaDebouncer,
        Polymer.Async.timeOut.after(500),
        () => OfflinePen.db.pens
          .update(this.currentId, Object.assign({}, change.base, { updatedAt: (new Date()).getTime() }))
          .then(() => this.hasSaved = true)
      );
    }

    editorChanged(e) {
      const type = e.currentTarget.dataset.type;
      if(!type) {
        return;
      }

      const value = e.detail.value;
      this.hasSaved = false;
      this._editorDebouncer = Polymer.Debouncer.debounce(
        this._editorDebouncer,
        Polymer.Async.timeOut.after(1000),
        () => {
          const currentFile = type in this._files ? this._files[type] : null;
          const file = {
            id: currentFile ? currentFile.id : cuid(),
            pen_id: this.currentId,
            name: `index.${type}`,
            content: value
          };
          return OfflinePen.db.files
            .put(file)
            .then(() => this._files[type] = file)
            .then(() => this.hasSaved = true)
        });
    }

    computeSaveState(saved) {
      return saved ? 'Saved.' : 'Changed...';
    }
  }

  customElements.define(ViewEditor.is, ViewEditor);
</script>
